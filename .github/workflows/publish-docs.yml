name: Publish Docs
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  docs:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
      - name: Cache built docs
        id: cache-docs
        uses: actions/cache@v4
        with:
          path: docs
          key: ${{ runner.os }}-docs-${{ hashFiles('OrzMC/Common/documentation.docc/**', '**/*.swift', '**/*.md') }}
      - uses: actions/cache@v4
        with:
          path: DerivedData
          key: ${{ runner.os }}-docs-derived-${{ hashFiles('**/*.swift', '**/*.xcodeproj/**') }}
      - uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData/SourcePackages
          key: ${{ runner.os }}-docs-spm-${{ hashFiles('**/Package.resolved') }}
      - name: Resolve package dependencies
        run: |
          xcrun xcodebuild -resolvePackageDependencies -scheme OrzMC
      - name: Build documentation
        if: steps.cache-docs.outputs.cache-hit != 'true'
        run: |
          mkdir -p DerivedData docs
          xcrun xcodebuild docbuild \
            -quiet \
            -scheme OrzMC \
            -destination "generic/platform=macOS" \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            -derivedDataPath DerivedData \
            -jobs $(sysctl -n hw.ncpu) \
            ONLY_ACTIVE_ARCH=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            SWIFT_SERIALIZE_DEBUGGING_OPTIONS=NO
          DOCCARCHIVE_PATH=$(find DerivedData -type d -name "OrzMC.doccarchive")
          xcrun docc process-archive transform-for-static-hosting \
            "$DOCCARCHIVE_PATH" \
            --output-path docs \
            --hosting-base-path "/${{ github.event.repository.name }}"
          touch docs/.nojekyll
          lowercase_scheme=$(echo "OrzMC" | tr '[:upper:]' '[:lower:]')
          cat > docs/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
              <meta http-equiv="refresh" content="0; url=/${{ github.event.repository.name }}/documentation/${lowercase_scheme}/">
          </head>
          <body>
              <p>Redirecting to <a href="/${{ github.event.repository.name }}/documentation/${lowercase_scheme}/">documentation</a>...</p>
          </body>
          </html>
          EOF
      - name: Use cached documentation
        if: steps.cache-docs.outputs.cache-hit == 'true'
        run: |
          echo "Using cached docs artifact"
      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: docs
          clean: true
          single-commit: true
          
