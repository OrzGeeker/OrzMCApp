name: Sparkle Appcast
on:
  workflow_call:
    inputs:
      products_path:
        required: true
        type: string
      dist_name:
        required: true
        type: string
      tag_name:
        required: true
        type: string
      derived_data_path:
        required: false
        type: string
        default: DerivedData
jobs:
  appcast:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate appcast
        shell: bash
        run: |
          BIN="${{ inputs.derived_data_path }}/SourcePackages/artifacts/sparkle/Sparkle/bin/generate_appcast"
          if [ ! -x "$BIN" ]; then echo "sparkle generate_appcast not found"; exit 1; fi
          "$BIN" "${{ inputs.products_path }}"
      - name: Update enclosure URL
        shell: bash
        run: |
          FILE="${{ inputs.dist_name }}"
          URL="https://github.com/${{ github.repository }}/releases/download/${{ inputs.tag_name }}/$FILE"
          ESCAPED_FILE=$(printf "%s" "$FILE" | sed 's/\./\\./g')
          ESCAPED_URL=$(printf "%s" "$URL" | sed 's/\./\\./g')
          sed -i'' -e "s|https://.*$ESCAPED_FILE|$ESCAPED_URL|" "${{ inputs.products_path }}/appcast.xml"
