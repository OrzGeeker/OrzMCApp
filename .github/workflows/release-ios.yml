name: Release iOS
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  ios:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
      - name: Install tools
        run: brew install jq
      - uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DIST_CERT_P12 }}
          p12-password: ${{ secrets.IOS_DIST_CERT_PASSWORD }}
      - name: Import provisioning profile (optional)
        if: secrets.IOS_PROVISIONING_PROFILE != ''
        uses: apple-actions/import-provisioning-profile@v1
        with:
          provisioning-profile-base64: ${{ secrets.IOS_PROVISIONING_PROFILE }}
      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - uses: actions/cache@v4
        with:
          path: DerivedData
          key: ${{ runner.os }}-derived-${{ hashFiles('**/*.swift', '**/*.xcodeproj/**') }}
      - uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
      - name: Build & archive iOS
        run: |
          SCHEME="OrzMC"
          mkdir -p build
          xcrun xcodebuild archive \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath build/${SCHEME}.xcarchive \
            -skipPackagePluginValidation \
            -skipMacroValidation
      - name: Export IPA
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>compileBitcode</key>
              <true/>
            </dict>
          </plist>
          EOF
          xcrun xcodebuild -exportArchive \
            -archivePath build/OrzMC.xcarchive \
            -exportOptionsPlist exportOptions.plist \
            -exportPath build/ios-export
      - name: Prepare App Store Connect API Key
        id: asc
        env:
          APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        run: |
          if [ -z "$APPSTORE_PRIVATE_KEY" ] || [ -z "$APPSTORE_KEY_ID" ] || [ -z "$APPSTORE_ISSUER_ID" ]; then
            echo "Missing App Store Connect API Key secrets" && exit 1
          fi
          KEY_FILE="AuthKey_${APPSTORE_KEY_ID}.p8"
          echo "$APPSTORE_PRIVATE_KEY" | base64 -d > "$KEY_FILE"
          chmod 600 "$KEY_FILE"
          echo "keyfile=$KEY_FILE" >> $GITHUB_OUTPUT
      - name: Pre-check IPA and bundle identifier
        id: precheck
        run: |
          IPA=$(ls build/ios-export/*.ipa | head -n1)
          if [ -z "$IPA" ] || [ ! -s "$IPA" ]; then echo "IPA not found or empty"; exit 1; fi
          rm -rf tmp && mkdir -p tmp
          unzip -q "$IPA" -d tmp
          INFOPLIST=$(find tmp/Payload -maxdepth 2 -name Info.plist | head -n1)
          if [ -z "$INFOPLIST" ]; then echo "Info.plist not found in IPA"; exit 1; fi
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$INFOPLIST")
          if [ -z "$BUNDLE_ID" ]; then echo "CFBundleIdentifier missing"; exit 1; fi
          echo "bundle_id=$BUNDLE_ID" >> $GITHUB_OUTPUT
          EXPECTED="${{ vars.IOS_BUNDLE_ID }}"
          if [ -n "$EXPECTED" ] && [ "$BUNDLE_ID" != "$EXPECTED" ]; then echo "Bundle ID mismatch: $BUNDLE_ID != $EXPECTED"; exit 1; fi
      - name: Validate ASC app exists for bundle id
        run: |
          now=$(date +%s)
          exp=$((now+1200))
          header=$(printf '{"alg":"ES256","kid":"%s","typ":"JWT"}' "${{ secrets.APPSTORE_KEY_ID }}")
          payload=$(printf '{"iss":"%s","iat":%d,"exp":%d,"aud":"appstoreconnect-v1"}' "${{ secrets.APPSTORE_ISSUER_ID }}" "$now" "$exp")
          b64url() { openssl base64 -e -A | tr '+/' '-_' | tr -d '='; }
          h_b64=$(printf "%s" "$header" | b64url)
          p_b64=$(printf "%s" "$payload" | b64url)
          signing_input="$h_b64.$p_b64"
          sig=$(printf "%s" "$signing_input" | openssl dgst -sha256 -sign "${{ steps.asc.outputs.keyfile }}" | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')
          token="$signing_input.$sig"
          bundle_id="${{ steps.precheck.outputs.bundle_id }}"
          count=$(curl -s -H "Authorization: Bearer $token" "https://api.appstoreconnect.apple.com/v1/apps?filter[bundleId]=$bundle_id" | jq -r '.data | length')
          if [ "$count" = "0" ] || [ -z "$count" ]; then echo "ASC app not found for bundle id: $bundle_id"; exit 1; fi
          rm -rf tmp
      - name: Upload IPA to TestFlight (API Key)
        if: ${{ vars.UPLOAD_TESTFLIGHT == 'true' }}
        run: |
          IPA=$(ls build/ios-export/*.ipa | head -n1)
          if [ -z "$IPA" ]; then echo "No IPA found"; exit 1; fi
          xcrun iTMSTransporter -m upload \
            -apiKey "${{ secrets.APPSTORE_KEY_ID }}" \
            -apiIssuer "${{ secrets.APPSTORE_ISSUER_ID }}" \
            -apiKeyFile "${{ steps.asc.outputs.keyfile }}" \
            -assetFile "$IPA"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios-export/*.ipa
