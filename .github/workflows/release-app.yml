name: Release App
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  app:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
      - uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.DEVELOPER_ID_CERT_P12 }}
          p12-password: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
      - run: brew install jq
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - uses: actions/cache@v4
        with:
          path: DerivedData
          key: ${{ runner.os }}-derived-${{ hashFiles('**/*.swift', '**/*.xcodeproj/**') }}
      - uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
      - uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData/ModuleCache.noindex
          key: ${{ runner.os }}-modulecache-${{ hashFiles('**/*.swift', '**/*.xcodeproj/**') }}
      - uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-swiftpmcache-${{ hashFiles('**/Package.resolved') }}
      - name: Resolve package dependencies
        run: |
          xcrun xcodebuild -resolvePackageDependencies -scheme OrzMC
      - name: Archive app
        run: |
          mkdir -p build
          xcrun xcodebuild archive \
            -scheme OrzMC \
            -configuration Release \
            -destination "generic/platform=macOS" \
            -archivePath build/OrzMC.xcarchive \
            -derivedDataPath DerivedData \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            SWIFT_SERIALIZE_DEBUGGING_OPTIONS=NO \
            -jobs $(sysctl -n hw.ncpu)
      - name: Export app (Developer ID)
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>teamID</key>
              <string>${TEAM_ID}</string>
              <key>method</key>
              <string>developer-id</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>Developer ID Application</string>
            </dict>
          </plist>
          EOF
          xcrun xcodebuild -exportArchive \
            -archivePath build/OrzMC.xcarchive \
            -exportOptionsPlist exportOptions.plist \
            -exportPath build/mac-export
      - name: Ensure Hardened Runtime (codesign)
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          APP="build/mac-export/OrzMC.app"
          IDENTITY_HASH=$(security find-identity -v -p codesigning | awk '/Developer ID Application/ {print $2; exit}')
          if [ -z "$IDENTITY_HASH" ]; then echo "Developer ID Application identity not found"; exit 1; fi
          ENTITLEMENTS="OrzMC/Common/OrzMC.entitlements"
          if [ ! -f "$ENTITLEMENTS" ]; then ENTITLEMENTS=""; fi
          /usr/bin/codesign --force --deep --options runtime --timestamp \
            ${ENTITLEMENTS:+--entitlements "$ENTITLEMENTS"} \
            --sign "$IDENTITY_HASH" "$APP"
          /usr/bin/codesign -vvv --deep --strict "$APP"
      - name: Notarize app (API Key)
        env:
          APPSTORE_PRIVATE_KEY: ${{ secrets.APPSTORE_PRIVATE_KEY }}
          APPSTORE_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          APPSTORE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          NOTARY_TIMEOUT_DURATION: ${{ vars.NOTARY_TIMEOUT_DURATION }}
        run: |
          if [ -z "$APPSTORE_PRIVATE_KEY" ] || [ -z "$APPSTORE_KEY_ID" ] || [ -z "$APPSTORE_ISSUER_ID" ]; then
            echo "Missing App Store Connect API Key secrets" && exit 1
          fi
          APP="build/mac-export/OrzMC.app"
          ZIP="$APP.zip"
          # Preflight: show code signature & runtime flags
          /usr/bin/codesign --verify --deep --strict --verbose=2 "$APP" || true
          /usr/bin/codesign -dv --verbose=4 "$APP" 2>&1 | tee codesign-info.txt
          ditto -c -k --sequesterRsrc --keepParent "$APP" "$ZIP"
          KEY_FILE="AuthKey_${APPSTORE_KEY_ID}.p8"
          echo "$APPSTORE_PRIVATE_KEY" | base64 -d > "$KEY_FILE"
          RESULT=$(xcrun notarytool submit \
            --key "$KEY_FILE" \
            --key-id "$APPSTORE_KEY_ID" \
            --issuer "$APPSTORE_ISSUER_ID" \
            --wait \
            --timeout "${NOTARY_TIMEOUT_DURATION:-5m}" \
            --output-format json \
            "$ZIP")
          STATUS=$(echo "$RESULT" | jq -r '.status')
          ID=$(echo "$RESULT" | jq -r '.id')
          echo "Notarization status: $STATUS, id: $ID"
          if [ "$STATUS" != "Accepted" ] || [ -z "$ID" ] || [ "$ID" = "null" ]; then
            echo "$RESULT"
            if [ -n "$ID" ] && [ "$ID" != "null" ]; then
              echo "Fetching notarization log..."
              xcrun notarytool log "$ID" --key "$KEY_FILE" --key-id "$APPSTORE_KEY_ID" --issuer "$APPSTORE_ISSUER_ID" --output-format json | tee notarization-log.json || true
            fi
            echo "Notarization not accepted"; exit 1
          fi
          rm -f "$KEY_FILE" "$ZIP"
          # Staple with retries to handle propagation delay
          ATTEMPTS=10
          SLEEP=30
          i=1
          while [ $i -le $ATTEMPTS ]; do
            if xcrun stapler staple "$APP"; then
              break
            else
              echo "Staple attempt $i failed, retrying after $SLEEP s..."
              sleep $SLEEP
              i=$((i+1))
            fi
          done
          if [ $i -gt $ATTEMPTS ]; then
            echo "Staple failed after $ATTEMPTS attempts"; exit 1
          fi
          spctl -a -t exec -vv "$APP"
      - name: Prepare distribution metadata
        id: meta
        run: |
          INFO="build/mac-export/OrzMC.app/Contents/Info.plist"
          SHORT_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$INFO")
          BUILD_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$INFO")
          DATE=$(date +%Y%m%d_%H%M%S)
          DIST_NAME="OrzMC_${SHORT_VERSION}_${BUILD_VERSION}_${DATE}.zip"
          DIST_PATH="products/$DIST_NAME"
          echo "short_version=$SHORT_VERSION" >> $GITHUB_OUTPUT
          echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "dist_name=$DIST_NAME" >> $GITHUB_OUTPUT
          echo "dist_path=$DIST_PATH" >> $GITHUB_OUTPUT
      - name: Create distribution zip
        run: |
          mkdir -p products
          ditto -c -k --sequesterRsrc --keepParent build/mac-export/OrzMC.app "${{ steps.meta.outputs.dist_path }}"
      - name: Import Sparkle private key
        env:
          SPARKLE_ED_PRIVATE_KEY: ${{ secrets.SPARKLE_ED_PRIVATE_KEY }}
        run: |
          if [ -z "$SPARKLE_ED_PRIVATE_KEY" ]; then echo "Missing SPARKLE_ED_PRIVATE_KEY secret"; exit 1; fi
          DERIVED="DerivedData"
          GEN="$DERIVED/SourcePackages/artifacts/sparkle/Sparkle/bin/generate_keys"
          if [ ! -x "$GEN" ]; then
            ALT=$(find "$HOME/Library/Developer/Xcode/DerivedData" -path "*/SourcePackages/artifacts/sparkle/Sparkle/bin/generate_keys" -print -quit 2>/dev/null)
            if [ -x "$ALT" ]; then GEN="$ALT"; fi
          fi
          if [ ! -x "$GEN" ]; then echo "sparkle generate_keys not found"; exit 1; fi
          PRIV="sparkle_ed_private_key"
          echo "$SPARKLE_ED_PRIVATE_KEY" | base64 -d > "$PRIV"
          "$GEN" -f "$PRIV"
          PUB=$("$GEN" -p | sed -n 's/.*<string>\(.*\)<\/string>.*/\1/p')
          INFO="build/mac-export/OrzMC.app/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :SUPublicEDKey $PUB" "$INFO" || /usr/libexec/PlistBuddy -c "Add :SUPublicEDKey string $PUB" "$INFO"
          rm -f "$PRIV"
      - name: Generate and update appcast
        uses: ./.github/actions/sparkle-appcast
        with:
          products_path: products
          dist_name: ${{ steps.meta.outputs.dist_name }}
          tag_name: ${{ steps.meta.outputs.short_version }}
          derived_data_path: DerivedData
      - name: Commit appcast.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add products/appcast.xml
          git commit -m "Update appcast.xml for ${{ steps.meta.outputs.dist_name }}" || echo "No changes"
          git push
      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.meta.outputs.short_version }}
          release_name: ${{ steps.meta.outputs.short_version }}
          draft: false
          prerelease: false
      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.meta.outputs.dist_path }}
          asset_name: ${{ steps.meta.outputs.dist_name }}
          asset_content_type: application/zip
